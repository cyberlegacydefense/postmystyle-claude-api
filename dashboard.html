<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="assets/images/favicon.png">
  <title>Dashboard - PostMyStyle.ai</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  <style>
    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f8f9fa;
        color: #333;
        line-height: 1.6;
        overflow-x: hidden;
    }

    .dashboard-container {
        display: grid;
        grid-template-columns: 280px 1fr;
        min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
        background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem 1.5rem;
        box-shadow: 4px 0 12px rgba(0, 0, 0, 0.1);
        z-index: 100;
        position: relative;
        overflow: hidden;
    }

    .sidebar::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .logo {
        text-align: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }

    .logo img {
        max-width: 180px;
        height: auto;
        margin-bottom: 0.5rem;
    }

    .logo p {
        font-size: 0.9rem;
        opacity: 0.8;
        margin-bottom: 1rem;
    }

    .nav-menu {
        list-style: none;
        position: relative;
        z-index: 1;
    }

    .nav-item {
        margin-bottom: 0.5rem;
    }

    .nav-link {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        color: white;
        text-decoration: none;
        border-radius: 8px;
        transition: all 0.3s ease;
        opacity: 0.8;
    }

    .nav-link:hover, .nav-link.active {
        background: rgba(255, 255, 255, 0.15);
        opacity: 1;
        transform: translateX(4px);
    }

    .nav-icon {
        margin-right: 0.75rem;
        font-size: 1.1rem;
    }

    .logout-btn-sidebar {
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
        padding: 0.4rem 0.75rem;
        border-radius: 15px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.8rem;
        margin-top: 0.5rem;
    }

    .logout-btn-sidebar:hover {
        background: rgba(255, 255, 255, 0.3);
    }

    /* Main Content */
    .main-content {
        padding: 2rem;
        overflow-y: auto;
        max-height: 100vh;
    }

    .dashboard-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .header-info h1 {
        font-size: 2rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.25rem;
    }

    .header-info p {
        color: #666;
        font-size: 1rem;
    }

    .header-actions {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .time-range-selector {
        background: white;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 0.5rem;
        display: flex;
        gap: 0.25rem;
    }

    .time-btn {
        padding: 0.5rem 1rem;
        background: none;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .time-btn.active {
        background: #667eea;
        color: white;
    }

    .refresh-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
    }

    .refresh-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
    }

    /* AI Business Advisor - Enhanced for Web */
    .ai-advisor-section {
        background: linear-gradient(135deg, #FF6B35, #ff8660);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        color: white;
        position: relative;
        overflow: hidden;
        box-shadow: 0 12px 32px rgba(255, 107, 53, 0.2);
    }

    .ai-advisor-section::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -50%;
        width: 200px;
        height: 200px;
        background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
        border-radius: 50%;
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translate(0, 0); }
        50% { transform: translate(10px, -10px); }
    }

    .ai-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 1;
    }

    .ai-title-section {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .ai-icon {
        width: 60px;
        height: 60px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        backdrop-filter: blur(10px);
        animation: glow 2s ease-in-out infinite alternate;
        position: relative;
        overflow: hidden;
    }

    .ai-icon::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
        transform: rotate(-45deg);
        animation: shine 3s ease-in-out infinite;
    }

    @keyframes shine {
        0% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
        50% { transform: translateX(100%) translateY(100%) rotate(-45deg); }
        100% { transform: translateX(-100%) translateY(-100%) rotate(-45deg); }
    }

    @keyframes glow {
        from { box-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        to { box-shadow: 0 0 20px rgba(255, 255, 255, 0.8); }
    }

    .ai-title {
        font-size: 1.8rem;
        font-weight: 700;
        margin: 0;
    }

    .ai-subtitle {
        font-size: 1rem;
        opacity: 0.9;
        margin: 0;
    }

    .ai-controls {
        display: flex;
        gap: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .ai-control-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 0.75rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .ai-control-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .ai-control-btn:hover::before {
        left: 100%;
    }

    .ai-control-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .ai-control-btn.active {
        background: rgba(255, 255, 255, 0.3);
    }

    .ai-content {
        background: rgba(255, 255, 255, 0.15);
        padding: 1.5rem;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
        margin-bottom: 1rem;
    }

    .ai-loading {
        display: flex;
        align-items: center;
        gap: 12px;
        color: white;
        font-style: italic;
    }

    .ai-spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top: 2px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .ai-message {
        font-size: 1.1rem;
        line-height: 1.7;
        color: white;
        margin-bottom: 1rem;
    }

    .ai-message strong {
        font-weight: 600;
    }

    .ai-expand-btn {
        background: none;
        border: none;
        color: white;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 5px 0;
        transition: all 0.3s ease;
        opacity: 0.9;
    }

    .ai-expand-btn:hover {
        opacity: 1;
        transform: translateX(5px);
    }

    .ai-quick-actions {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }

    .quick-actions-title {
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1rem;
    }

    .quick-actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .quick-action-btn {
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        padding: 1rem;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        backdrop-filter: blur(10px);
        position: relative;
        overflow: hidden;
    }

    .quick-action-btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .quick-action-btn:hover::before {
        left: 100%;
    }

    .quick-action-btn:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
    }

    .quick-action-title {
        font-weight: 600;
        margin-bottom: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .quick-action-desc {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .custom-question-section {
        background: rgba(255, 255, 255, 0.1);
        padding: 1.5rem;
        border-radius: 12px;
        margin-bottom: 1rem;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }

    .custom-question-title {
        font-size: 1rem;
        font-weight: 600;
        color: white;
        margin-bottom: 1rem;
    }

    .question-input-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }

    .question-input {
        flex: 1;
        padding: 12px;
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 8px;
        font-size: 0.9rem;
        resize: vertical;
        min-height: 80px;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        backdrop-filter: blur(10px);
    }

    .question-input::placeholder {
        color: rgba(255, 255, 255, 0.7);
    }

    .question-input:focus {
        outline: none;
        border-color: rgba(255, 255, 255, 0.5);
        background: rgba(255, 255, 255, 0.25);
    }

    .question-send-btn {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }

    .question-send-btn:hover {
        background: rgba(255, 255, 255, 0.4);
        transform: translateY(-2px);
    }

    .question-send-btn:disabled {
        background: rgba(255, 255, 255, 0.1);
        cursor: not-allowed;
        transform: none;
    }

    .question-hint {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.8);
        margin: 0;
    }

    .ai-stage-indicator {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        margin-top: 1rem;
        position: relative;
        z-index: 1;
    }

    .ai-stage-text {
        font-size: 0.85rem;
        color: rgba(255, 255, 255, 0.9);
        font-weight: 500;
    }

    .ai-last-updated {
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.7);
        font-style: italic;
    }

    .ai-welcome {
        text-align: center;
        color: rgba(255, 255, 255, 0.9);
        margin-bottom: 1rem;
    }

    /* Enhanced Metrics Grid */
    .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .metric-card {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
    }

    .metric-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.12);
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, #667eea, #764ba2);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .metric-card:hover::before {
        transform: scaleX(1);
    }

    .metric-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .metric-icon {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
    }

    .metric-trend {
        background: #e8f5e8;
        color: #22c55e;
        padding: 0.25rem 0.5rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .metric-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #1a1a1a;
        margin-bottom: 0.5rem;
        transition: all 0.3s ease;
    }

    .metric-card:hover .metric-value {
        transform: scale(1.05);
    }

    .metric-label {
        color: #666;
        font-weight: 500;
    }

    .loading-stats {
        opacity: 0.6;
    }

    .loading-stats .metric-value {
        color: #ccc;
    }

    /* Advanced Charts Section */
    .charts-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .chart-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
    }

    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .chart-title {
        font-size: 1.3rem;
        font-weight: 600;
        color: #1a1a1a;
    }

    .chart-controls {
        display: flex;
        gap: 0.5rem;
    }

    .chart-control {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .chart-control.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
    }

    .chart-canvas {
        position: relative;
        height: 300px;
        width: 100%;
    }

    /* Team Performance Table */
    .performance-table {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
        margin-bottom: 2rem;
    }

    .table-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }

    .performance-grid {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr 1fr 1fr 1fr;
        gap: 1rem;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid #f0f0f0;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .performance-grid:hover {
        background: #f8f9fa;
        transform: scale(1.01);
    }

    .performance-grid:last-child {
        border-bottom: none;
    }

    .stylist-info {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .stylist-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
    }

    .performance-metric {
        text-align: center;
        font-weight: 600;
    }

    .performance-value {
        font-size: 1.1rem;
        color: #1a1a1a;
    }

    .performance-label {
        font-size: 0.8rem;
        color: #666;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Insights Panel */
    .insights-panel {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        border: 1px solid #f0f0f0;
    }

    .insight-item {
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
    }

    .insight-positive {
        background: #f0f9ff;
        border-left-color: #22c55e;
    }

    .insight-warning {
        background: #fef3c7;
        border-left-color: #f59e0b;
    }

    .insight-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
    }

    .insight-desc {
        font-size: 0.9rem;
        color: #666;
    }

    /* Auto-refresh indicator */
    .refresh-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #22c55e, #16a34a);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        opacity: 0;
        transform: translateY(-20px);
        transition: all 0.3s ease;
        z-index: 1001;
    }

    .refresh-indicator.show {
        opacity: 1;
        transform: translateY(0);
    }

    /* ENHANCED DRILL-DOWN MODAL STYLES */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
        backdrop-filter: blur(5px);
    }

    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }

    .modal-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 900px;
        max-height: 85vh;
        overflow-y: auto;
        margin: 1rem;
        position: relative;
        transform: scale(0.8);
        transition: transform 0.3s ease;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }

    .modal-overlay.active .modal-content {
        transform: scale(1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: #333;
    }

    .modal-close {
        background: #f8f9fa;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: #666;
        padding: 0.5rem;
        border-radius: 50%;
        transition: all 0.3s ease;
    }

    .modal-close:hover {
        background: #e9ecef;
        color: #333;
        transform: rotate(90deg);
    }

    .stylist-card {
        background: #f8f9fa;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 1rem;
        border-left: 4px solid #667eea;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stylist-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
        transition: left 0.5s;
    }

    .stylist-card:hover::before {
        left: 100%;
    }

    .stylist-card:hover {
        background: white;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        transform: translateY(-2px);
    }

    .stylist-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .stylist-avatar-large {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: linear-gradient(135deg, #667eea, #764ba2);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 600;
        font-size: 24px;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }

    .stylist-info h3 {
        margin: 0;
        color: #333;
        font-size: 1.3rem;
    }

    .stylist-info p {
        margin: 0;
        color: #666;
        font-size: 0.9rem;
    }

    .stylist-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 1rem;
    }

    .stylist-stat {
        text-align: center;
        background: white;
        padding: 1rem;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .stylist-stat:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .stylist-stat-number {
        font-size: 1.8rem;
        font-weight: 700;
        color: #667eea;
    }

    .stylist-stat-label {
        font-size: 0.8rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .error-message {
        background: linear-gradient(135deg, #f8d7da, #f5c6cb);
        color: #721c24;
        padding: 1.5rem;
        border-radius: 15px;
        margin: 1rem 0;
        text-align: center;
        border-left: 4px solid #dc3545;
    }

    /* Responsive Design */
    @media (max-width: 1200px) {
        .dashboard-container {
            grid-template-columns: 1fr;
        }

        .sidebar {
            display: none;
        }

        .charts-section {
            grid-template-columns: 1fr;
        }

        .metrics-grid {
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 1rem;
        }

        .ai-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .ai-controls {
            order: -1;
            align-self: flex-end;
        }

        .quick-actions-grid {
            grid-template-columns: 1fr;
        }

        .question-input-row {
            flex-direction: column;
        }

        .modal-content {
            margin: 0.5rem;
            max-height: 90vh;
        }
    }
  </style>
</head>
<body>
<div class="dashboard-container">
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="logo">
      <img src="https://res.cloudinary.com/dkstyvfzo/image/upload/v1750698482/postmystyletitle_tuls98.png" alt="PostMyStyle.ai">
      <p>PostMyStyle AI Analytics</p>

      <!-- User info moved here -->
      <div style="background: rgba(255, 255, 255, 0.15); padding: 0.75rem; border-radius: 8px; backdrop-filter: blur(10px); margin-top: 0.5rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
          <div style="width: 30px; height: 30px; border-radius: 50%; background: rgba(255, 255, 255, 0.2); display: flex; align-items: center; justify-content: center; font-size: 0.9rem;">👤</div>
          <div style="font-weight: 600; font-size: 0.85rem;" id="userNameSidebar">Loading...</div>
        </div>
        <button class="logout-btn-sidebar" onclick="logout()" style="width: 100%; margin-top: 0;">Log Out</button>
      </div>
    </div>

    <ul class="nav-menu">
      <li class="nav-item">
        <a href="#" class="nav-link active" onclick="showDashboard()">
          <span class="nav-icon">📊</span>
          <span>Dashboard</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showTeamPerformance()">
          <span class="nav-icon">👥</span>
          <span>Team Performance</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showSocialAnalytics()">
          <span class="nav-icon">📱</span>
          <span>Social Analytics</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showRevenueTracking()">
          <span class="nav-icon">💰</span>
          <span>Revenue Tracking</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showGoalsTargets()">
          <span class="nav-icon">🎯</span>
          <span>Goals & Targets</span>
        </a>
      </li>
      <li class="nav-item">
        <a href="#" class="nav-link" onclick="showSettings()">
          <span class="nav-icon">⚙️</span>
          <span>Settings</span>
        </a>
      </li>
    </ul>
  </div>

  <!-- Auto-refresh indicator -->
  <div class="refresh-indicator" id="refreshIndicator">
    🔄 Data refreshed automatically
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
      <div class="header-info">
        <h1 id="salonNameHeader">Loading...</h1>
        <p id="dashboardSubtitle">Team Analytics Dashboard • Auto-refresh enabled</p>
      </div>
      <div class="header-actions">
        <div class="time-range-selector">
          <button class="time-btn">24H</button>
          <button class="time-btn active">7D</button>
          <button class="time-btn">30D</button>
          <button class="time-btn">90D</button>
        </div>
        <button class="refresh-btn" onclick="refreshDashboard()">
          🔄 Refresh
        </button>
      </div>
    </div>

    <!-- AI Business Advisor Section -->
    <div class="ai-advisor-section">
      <div class="ai-header">
        <div class="ai-title-section">
          <div class="ai-icon">✨</div>
          <div>
            <h2 class="ai-title">AI Business Advisor</h2>
            <p class="ai-subtitle">Personalized insights for your salon team</p>
          </div>
        </div>
        <div class="ai-controls">
          <button class="ai-control-btn" id="quickActionsBtn" onclick="toggleQuickActions()" title="Quick Questions">💬</button>
          <button class="ai-control-btn" id="customQuestionBtn" onclick="toggleCustomQuestion()" title="Ask Question">✏️</button>
          <button class="ai-control-btn" onclick="generateAIInsights(true)" title="Generate New Insights">🔄</button>
        </div>
      </div>

      <div class="ai-content" id="aiContent">
        <div class="ai-loading" id="aiLoading" style="display: none;">
          <div class="ai-spinner"></div>
          <span>Generating personalized business insights...</span>
        </div>
        <div id="aiMessage" style="display: none;">
          <div class="ai-message" id="aiMessageText"></div>
          <button class="ai-expand-btn" id="aiExpandBtn" style="display: none;" onclick="toggleAIMessage()">
            <span id="expandText">Read More</span> <span id="expandIcon">▼</span>
          </button>
        </div>
        <div id="aiWelcome" class="ai-welcome">
          <p style="margin-bottom: 1rem;">
            👋 Welcome! Click the refresh button above to get personalized business insights based on your salon's performance data.
          </p>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="ai-quick-actions" id="quickActionsSection" style="display: none;">
        <div class="quick-actions-title">Get instant advice about:</div>
        <div class="quick-actions-grid">
          <button class="quick-action-btn" onclick="askQuickQuestion('revenue')">
            <div class="quick-action-title">💰 Increasing Revenue</div>
            <div class="quick-action-desc">Optimize team productivity</div>
          </button>
          <button class="quick-action-btn" onclick="askQuickQuestion('clients')">
            <div class="quick-action-title">👥 Client Acquisition</div>
            <div class="quick-action-desc">Scale your salon business</div>
          </button>
          <button class="quick-action-btn" onclick="askQuickQuestion('team')">
            <div class="quick-action-title">⭐ Team Performance</div>
            <div class="quick-action-desc">Boost online engagement</div>
          </button>
          <button class="quick-action-btn" onclick="askQuickQuestion('marketing')">
            <div class="quick-action-title">📱 Marketing Strategy</div>
            <div class="quick-action-desc">Increase profitability</div>
          </button>
        </div>
      </div>

      <!-- Custom Question -->
      <div class="custom-question-section" id="customQuestionSection" style="display: none;">
        <div class="custom-question-title">Ask your own question:</div>
        <div class="question-input-row">
          <textarea class="question-input" id="customQuestionInput" placeholder="e.g., How can we improve our Instagram engagement?" maxlength="300"></textarea>
          <button class="question-send-btn" id="questionSendBtn" onclick="askCustomQuestion()">Send</button>
        </div>
        <p class="question-hint">💡 I'll analyze your salon's data to provide personalized advice</p>
      </div>

      <!-- AI Stage Indicator -->
      <div class="ai-stage-indicator">
        <span class="ai-stage-text" id="aiStageText">Business Stage: Growing Salon</span>
        <span class="ai-last-updated" id="aiLastUpdated"></span>
      </div>
    </div>

    <!-- Key Metrics Grid -->
    <div class="metrics-grid">
      <div class="metric-card loading-stats" onclick="openDrillDown('stylists')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">👥</div>
          <div class="metric-trend" id="stylistsChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalStylists">-</div>
        <div class="metric-label">Active Stylists</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('posts')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #4CAF50, #66BB6A);">📱</div>
          <div class="metric-trend" id="sharesChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalShares">-</div>
        <div class="metric-label">Posts Created</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('views')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #FF9800, #FFB74D);">👁️</div>
          <div class="metric-trend" id="viewsChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalViews">-</div>
        <div class="metric-label">Total Views</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('clients')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #9C27B0, #BA68C8);">💝</div>
          <div class="metric-trend" id="clientsChange">Loading...</div>
        </div>
        <div class="metric-value" id="totalClients">-</div>
        <div class="metric-label">Total Clients</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('engagement')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #E91E63, #F06292);">❤️</div>
          <div class="metric-trend" id="engagementChange">Loading...</div>
        </div>
        <div class="metric-value" id="engagementRate">-</div>
        <div class="metric-label">Avg Engagement</div>
      </div>

      <div class="metric-card loading-stats" onclick="openDrillDown('products')">
        <div class="metric-header">
          <div class="metric-icon" style="background: linear-gradient(135deg, #FF5722, #FF8A65);">🛍️</div>
          <div class="metric-trend" id="productChange">Loading...</div>
        </div>
        <div class="metric-value" id="productClicks">-</div>
        <div class="metric-label">Product Clicks</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="charts-section">
      <div class="chart-container">
        <div class="chart-header">
          <h3 class="chart-title">Team Activity Trends</h3>
          <div class="chart-controls">
            <button class="chart-control active">Posts</button>
            <button class="chart-control">Views</button>
            <button class="chart-control">Engagement</button>
          </div>
        </div>
        <div class="chart-canvas">
          <canvas id="activityChart"></canvas>
        </div>
      </div>

      <div class="insights-panel">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h3 class="chart-title">AI Performance Insights</h3>
          <button onclick="generatePerformanceInsights()" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">🔄 Refresh</button>
        </div>

        <div id="performanceInsightsContent">
          <div style="text-align: center; padding: 2rem; color: #666;">
            <div style="font-size: 2rem; margin-bottom: 1rem;">🧠</div>
            <p>Click refresh to generate AI-powered insights based on your team's performance data.</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Team Performance Table -->
    <div class="performance-table">
      <div class="table-header">
        <h3 class="chart-title">Team Performance Leaderboard</h3>
        <div class="chart-controls">
          <button class="chart-control active">This Week</button>
          <button class="chart-control">This Month</button>
          <button class="chart-control">This Quarter</button>
        </div>
      </div>

      <div class="performance-grid" style="font-weight: 600; color: #666; border-bottom: 2px solid #e9ecef;">
        <div>Stylist</div>
        <div class="performance-label">Posts</div>
        <div class="performance-label">Views</div>
        <div class="performance-label">Clients</div>
        <div class="performance-label">Engagement</div>
        <div class="performance-label">Score</div>
      </div>

      <div id="performanceTableBody">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
  </div>
</div>

<!-- Enhanced Drill-Down Modal -->
<div class="modal-overlay" id="drillDownModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title" id="modalTitle">Stylist Details</h2>
      <button class="modal-close" onclick="closeDrillDown()">×</button>
    </div>
    <div id="modalContent">
      <!-- Content will be populated by JavaScript -->
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  // Supabase Configuration
  const supabaseUrl = 'https://mffqaqvjylkotkgvytro.supabase.co';
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1mZnFhcXZqeWxrb3RrZ3Z5dHJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDYxMTI5MzYsImV4cCI6MjA2MTY4ODkzNn0.oUlS-JS1G9OHjwv89xZY_QRqwsoI-GE8c-ZE_U2TjDc';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // Global variables
  let currentUser = null;
  let salonData = null;
  let aiMessageFull = '';
  let aiMessageTruncated = '';
  let isAIExpanded = false;
  let stylistsData = [];

  // AI-related variables
  let lastAIGeneration = 0;
  let isGeneratingAI = false;

  // Chart instances
  let activityChart = null;

  // Auto-refresh variables
  let autoRefreshInterval = null;
  const AUTO_REFRESH_MINUTES = 5;
  let isDashboardLoaded = false;

  // UNIFIED AI SERVICE FUNCTION - CONTEXT AWARE
  async function callAIService(prompt, actionType = 'overview', analyticsData = null) {
      try {
          let totalStylists, totalClients, totalShares, totalViews, engagementRate;

          if (analyticsData) {
              // Use provided analytics data (preferred)
              totalStylists = analyticsData.total_stylists || 0;
              totalClients = analyticsData.total_clients || 0;
              totalShares = analyticsData.total_media_sends || 0;
              totalViews = analyticsData.total_clicks || 0;
              const totalSocial = (analyticsData.total_instagram_shares || 0) +
                                (analyticsData.total_facebook_shares || 0) +
                                (analyticsData.total_tiktok_shares || 0);
              engagementRate = totalShares > 0 ? Math.round((totalSocial / totalShares) * 100) : 0;
          } else {
              // Fallback to DOM elements, but only if they contain actual numbers
              const totalStylistsEl = document.getElementById('totalStylists');
              const totalClientsEl = document.getElementById('totalClients');
              const totalSharesEl = document.getElementById('totalShares');
              const totalViewsEl = document.getElementById('totalViews');
              const engagementRateEl = document.getElementById('engagementRate');

              const stylistText = totalStylistsEl ? totalStylistsEl.textContent.trim() : '0';
              const clientText = totalClientsEl ? totalClientsEl.textContent.trim() : '0';
              const shareText = totalSharesEl ? totalSharesEl.textContent.trim() : '0';
              const viewText = totalViewsEl ? totalViewsEl.textContent.trim() : '0';
              const engagementText = engagementRateEl ? engagementRateEl.textContent.trim() : '0%';

              // Only parse if not loading states
              totalStylists = (stylistText !== '-' && stylistText !== 'Loading...') ? parseInt(stylistText) || 0 : 0;
              totalClients = (clientText !== '-' && clientText !== 'Loading...') ? parseInt(clientText) || 0 : 0;
              totalShares = (shareText !== '-' && shareText !== 'Loading...') ? parseInt(shareText) || 0 : 0;
              totalViews = (viewText !== '-' && viewText !== 'Loading...') ? parseInt(viewText) || 0 : 0;
              engagementRate = (engagementText !== '-' && engagementText !== 'Loading...') ? parseInt(engagementText) || 0 : 0;
          }

          const salonName = salonData?.salon_name || 'Your Salon';

          let message;
          if (actionType === 'overview') {
              message = `You are a business advisor for ${salonName}. Current metrics: ${totalStylists} stylists, ${totalClients} clients, ${totalShares} posts, ${totalViews} views, ${engagementRate}% engagement. Provide 2-3 actionable business insights. Only respond with the insights, no meta-text about word limits.`;
          } else {
              message = `Business question for ${salonName} (${totalStylists} stylists, ${totalClients} clients): ${actionType}. Give specific actionable advice. Only respond with the advice, no meta-text about word limits or instructions.`;
          }

          const response = await fetch('https://postmystyle.ai/.netlify/functions/salon-ai', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ message: message })
          });

          if (!response.ok) {
              throw new Error(`AI service error: ${response.status}`);
          }

          const data = await response.json();
          return data.content[0].text || 'AI advice generated successfully.';

      } catch (error) {
          console.error('AI service call failed:', error);
          throw error;
      }
  }

  // Load user info and salon analytics
  async function loadDashboard() {
      // Prevent multiple initializations
      if (isDashboardLoaded) {
          console.log('Dashboard already loaded, skipping...');
          return;
      }

      try {
          // Get current user
          const { data: { user }, error: userError } = await supabase.auth.getUser();

          if (userError || !user) {
              console.log('No authenticated user, redirecting to login');
              window.location.href = 'login.html';
              return;
          }

          currentUser = user;
          console.log('Current user:', user.id);

          // Update user name in header and sidebar
          const userName = `${user.user_metadata?.first_name || 'User'} ${user.user_metadata?.last_name || ''}`.trim();
          document.getElementById('userNameSidebar').textContent = userName;

          // Get user's salon information
          const { data: userSalon, error: salonError } = await supabase
              .from('user_salon_view')
              .select('*')
              .eq('user_id', user.id)
              .single();

          if (salonError || !userSalon) {
              console.log('No salon found for user, they may need to complete onboarding');
              showErrorState('No salon profile found. Please complete your salon setup.');
              return;
          }

          salonData = userSalon;
          console.log('Salon data:', salonData);

          // Update header sections
          document.getElementById('salonNameHeader').textContent = salonData.salon_name;
          updateLastRefreshedTime();

          // Load and display analytics
          await loadSalonAnalytics(salonData.salon_id);

          // Load stylists data for drill-down
          await loadStylistsData(salonData.salon_id);

          // Initialize charts only if not already initialized
          if (!activityChart) {
              initializeCharts();
              // Show loading state immediately
              showChartLoading();
          }

          // Start auto-refresh
          startAutoRefresh();

          // Mark dashboard as loaded
          isDashboardLoaded = true;
          console.log('Dashboard initialization complete');

      } catch (error) {
          console.error('Error loading dashboard:', error);
          showErrorState('Failed to load dashboard data. Please refresh the page.');
      }
  }

  // Auto-refresh functionality
  function startAutoRefresh() {
      // Clear any existing interval
      if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
      }

      // Set up auto-refresh every 5 minutes
      autoRefreshInterval = setInterval(async () => {
          console.log('Auto-refreshing dashboard data...');

          // Show refresh indicator
          showRefreshIndicator();

          if (salonData) {
              // Only refresh data, don't reinitialize charts
              await loadSalonAnalytics(salonData.salon_id);
              await loadStylistsData(salonData.salon_id);
              updateLastRefreshedTime();
          }
      }, AUTO_REFRESH_MINUTES * 60 * 1000);

      console.log(`Auto-refresh started: every ${AUTO_REFRESH_MINUTES} minutes`);
  }

  function showRefreshIndicator() {
      const indicator = document.getElementById('refreshIndicator');
      indicator.classList.add('show');

      setTimeout(() => {
          indicator.classList.remove('show');
      }, 3000);
  }

  function updateLastRefreshedTime() {
      const now = new Date();
      const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
      document.getElementById('dashboardSubtitle').textContent =
          `Team Analytics Dashboard • Last updated: ${timeString} • Auto-refresh: ${AUTO_REFRESH_MINUTES}min`;
  }

  // Load detailed stylists data for drill-down functionality
  async function loadStylistsData(salonId) {
      try {
          const { data: stylists, error } = await supabase
              .from('stylists')
              .select('*')
              .eq('salon_id', salonId);

          if (error) throw error;

          // For each stylist, get their analytics
          stylistsData = await Promise.all(stylists.map(async (stylist) => {
              // Get media sends
              const { data: mediaSends } = await supabase
                  .from('media_send')
                  .select('*')
                  .eq('stylist_id', stylist.id);

              // Get unique clients
              const { data: clients } = await supabase
                  .from('stylist_clients')
                  .select('client_id')
                  .eq('stylist_id', stylist.id);

              const totalPosts = mediaSends?.length || 0;
              const totalViews = mediaSends?.reduce((sum, ms) => sum + (ms.click_count || 0), 0) || 0;
              const totalClients = clients?.length || 0;
              const engagementRate = totalPosts > 0 ? Math.round(((mediaSends?.reduce((sum, ms) => sum + (ms.share_instagram || 0) + (ms.share_facebook || 0) + (ms.share_tiktok || 0), 0) || 0) / totalPosts) * 100) : 0;

              return {
                  ...stylist,
                  totalPosts,
                  totalViews,
                  totalClients,
                  engagementRate
              };
          }));

          console.log('Stylists data loaded:', stylistsData);

          // Update team performance table
          updateTeamPerformanceTable();

          // Update charts with real stylist data - ensure it's called
          updateCharts(currentAnalyticsData);

          // Generate AI performance insights
          generatePerformanceInsights();

      } catch (error) {
          console.error('Error loading stylists data:', error);
      }
  }

  // Load salon analytics data
  async function loadSalonAnalytics(salonId) {
      try {
          console.log('Loading analytics for salon:', salonId);

          // Get salon analytics from the view we created
          const { data: analyticsData, error: analyticsError } = await supabase
              .from('salon_analytics_view')
              .select('*')
              .eq('salon_id', salonId)
              .single();

          if (analyticsError) {
              console.log('Analytics view error:', analyticsError);
              // If view doesn't exist, calculate manually
              await loadSalonAnalyticsManual(salonId);
              return;
          }

          console.log('Analytics data:', analyticsData);
          displayAnalytics(analyticsData);

      } catch (error) {
          console.error('Error loading salon analytics:', error);
          await loadSalonAnalyticsManual(salonId);
      }
  }

  // Fallback: Calculate analytics manually if view doesn't work
  async function loadSalonAnalyticsManual(salonId) {
      try {
          console.log('Calculating analytics manually for salon:', salonId);

          // Get stylists count
          const { data: stylists, error: stylistsError } = await supabase
              .from('stylists')
              .select('id')
              .eq('salon_id', salonId);

          // Get total clients through stylist relationships
          const { data: clients, error: clientsError } = await supabase
              .from('stylist_clients')
              .select('client_id, stylists!inner(salon_id)')
              .eq('stylists.salon_id', salonId);

          // Get media sends (posts) from salon stylists
          const { data: mediaSends, error: mediaError } = await supabase
              .from('media_send')
              .select('*, stylists!inner(salon_id)')
              .eq('stylists.salon_id', salonId);

          // Get product interactions
          const { data: productInteractions, error: productError } = await supabase
              .from('product_interactions')
              .select('*, media_send!inner(*, stylists!inner(salon_id))')
              .eq('media_send.stylists.salon_id', salonId);

          // Calculate metrics
          const totalStylists = stylists?.length || 0;
          const totalClients = clients ? new Set(clients.map(c => c.client_id)).size : 0;
          const totalShares = mediaSends?.length || 0;
          const totalViews = mediaSends?.reduce((sum, ms) => sum + (ms.click_count || 0), 0) || 0;
          const totalInstagram = mediaSends?.reduce((sum, ms) => sum + (ms.share_instagram || 0), 0) || 0;
          const totalFacebook = mediaSends?.reduce((sum, ms) => sum + (ms.share_facebook || 0), 0) || 0;
          const totalTikTok = mediaSends?.reduce((sum, ms) => sum + (ms.share_tiktok || 0), 0) || 0;
          const totalProductClicks = productInteractions?.length || 0;

          const analyticsData = {
              total_stylists: totalStylists,
              total_clients: totalClients,
              total_media_sends: totalShares,
              total_clicks: totalViews,
              total_instagram_shares: totalInstagram,
              total_facebook_shares: totalFacebook,
              total_tiktok_shares: totalTikTok,
              total_product_clicks: totalProductClicks
          };

          console.log('Manual analytics calculated:', analyticsData);
          displayAnalytics(analyticsData);

      } catch (error) {
          console.error('Error calculating manual analytics:', error);
          showErrorState('Unable to load analytics data.');
      }
  }

  // Store analytics data globally for AI context
  let currentAnalyticsData = null;

  // Display analytics data in the UI
  function displayAnalytics(data) {
      // Store for AI context
      currentAnalyticsData = data;
      // Remove loading states
      document.querySelectorAll('.metric-card').forEach(card => {
          card.classList.remove('loading-stats');
      });

      // Update stat numbers
      document.getElementById('totalStylists').textContent = data.total_stylists || 0;
      document.getElementById('totalClients').textContent = data.total_clients || 0;
      document.getElementById('totalShares').textContent = data.total_media_sends || 0;
      document.getElementById('totalViews').textContent = data.total_clicks || 0;
      document.getElementById('productClicks').textContent = data.total_product_clicks || 0;

      // Calculate engagement rate
      const totalSocial = (data.total_instagram_shares || 0) + (data.total_facebook_shares || 0) + (data.total_tiktok_shares || 0);
      const engagementRate = data.total_media_sends > 0 ? Math.round((totalSocial / data.total_media_sends) * 100) : 0;
      document.getElementById('engagementRate').textContent = `${engagementRate}%`;

      // Update change indicators
      updateChangeIndicators(data);

      // Update charts with real data (will be called again when stylist data loads)
      if (stylistsData && stylistsData.length > 0) {
          updateCharts(data);
      }

      console.log('Analytics displayed successfully');
  }

  // Update change indicators with encouraging messages
  function updateChangeIndicators(data) {
      const changes = {
          stylistsChange: data.total_stylists > 0 ? '↗ +2 this month' : 'Add First Stylist',
          clientsChange: data.total_clients > 0 ? `↗ +${Math.floor(data.total_clients * 0.1)} new this month` : 'Start Building',
          sharesChange: data.total_media_sends > 0 ? '↗ +42 this week' : 'Ready to Post',
          viewsChange: data.total_clicks > 0 ? '↗ +31% reach growth' : 'Audience Ready',
          engagementChange: data.total_media_sends > 0 ? '↗ +18% engagement' : 'Ready to Share',
          productChange: data.total_product_clicks > 0 ? '↗ +28% clicks' : 'Products Ready'
      };

      Object.entries(changes).forEach(([id, text]) => {
          const element = document.getElementById(id);
          if (element) {
              element.textContent = text;
              element.className = data.total_media_sends > 0 ? 'metric-trend' : 'metric-trend';
          }
      });
  }

  // Initialize Chart.js charts
  function initializeCharts() {
      // Destroy existing chart if it exists
      if (activityChart) {
          activityChart.destroy();
          activityChart = null;
      }

      // Activity Trends Chart - Start with empty data, will be populated when stylist data loads
      const activityCtx = document.getElementById('activityChart').getContext('2d');

      activityChart = new Chart(activityCtx, {
          type: 'line',
          data: {
              labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
              datasets: [] // Start empty, will be populated with real data
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      position: 'bottom',
                      labels: {
                          usePointStyle: true,
                          padding: 20
                      }
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      grid: {
                          color: '#f0f0f0'
                      }
                  },
                  x: {
                      grid: {
                          display: false
                      }
                  }
              },
              elements: {
                  point: {
                      radius: 6,
                      hoverRadius: 8
                  }
              }
          }
      });
  }

  // Update charts with real data
  function updateCharts(data) {
      console.log('updateCharts called with data:', !!data, 'stylistsData length:', stylistsData?.length);

      // Wait for both chart and stylist data to be ready
      if (!activityChart) {
          console.log('Chart not initialized yet, skipping update');
          return;
      }

      if (!stylistsData || stylistsData.length === 0) {
          console.log('No stylist data available, showing placeholder');
          showChartPlaceholder();
          return;
      }

      console.log('Updating chart with real stylist data:', stylistsData);

      // Get top 4 stylists by activity
      const topStylists = stylistsData
          .sort((a, b) => b.totalPosts - a.totalPosts)
          .slice(0, 4);

      // Color palette for datasets
      const colors = [
          { border: '#667eea', background: '#667eea20' },
          { border: '#4CAF50', background: '#4CAF5020' },
          { border: '#FF9800', background: '#FF980020' },
          { border: '#E91E63', background: '#E91E6320' }
      ];

      // Clear existing datasets
      activityChart.data.datasets = [];

      // Add dataset for each stylist
      topStylists.forEach((stylist, index) => {
          const color = colors[index] || colors[0];
          const weeklyData = generateRealisticWeeklyData(stylist);

          activityChart.data.datasets.push({
              label: stylist.stylist_name,
              data: weeklyData,
              borderColor: color.border,
              backgroundColor: color.background,
              tension: 0.4,
              fill: true
          });
      });

      activityChart.update('active');
      console.log('Chart updated successfully with', topStylists.length, 'stylists');
  }

  // Show placeholder when no data is available
  function showChartPlaceholder() {
      if (!activityChart) return;

      activityChart.data.datasets = [{
          label: 'Add stylists to see activity trends',
          data: [0, 0, 0, 0, 0, 0, 0],
          borderColor: '#e2e8f0',
          backgroundColor: '#f8fafc',
          tension: 0.4,
          fill: true,
          pointRadius: 0
      }];

      activityChart.update('none');
  }

  // Show loading state for chart
  function showChartLoading() {
      if (!activityChart) return;

      activityChart.data.datasets = [{
          label: 'Loading team data...',
          data: [1, 2, 1, 3, 2, 4, 2],
          borderColor: '#cbd5e1',
          backgroundColor: '#f1f5f9',
          tension: 0.4,
          fill: true,
          pointRadius: 0
      }];

      activityChart.update('none');
  }

  // Generate realistic weekly data distribution based on stylist's actual activity
  function generateRealisticWeeklyData(stylist) {
      // Base weekly patterns (salon industry typical patterns)
      // Tuesday-Saturday are peak days, Sunday/Monday slower
      const weeklyPattern = [0.6, 1.2, 1.0, 1.1, 1.3, 1.4, 0.4]; // Mon-Sun multipliers

      // Calculate average daily posts based on total posts
      const avgDailyPosts = stylist.totalPosts / 30; // Assuming 30-day period

      // Apply pattern and add some realistic variation
      return weeklyPattern.map((multiplier, dayIndex) => {
          const baseValue = avgDailyPosts * multiplier * 7; // Weekly scaling
          const variation = (Math.random() - 0.5) * 0.3; // ±15% variation
          const finalValue = Math.max(0, Math.round(baseValue * (1 + variation)));

          return finalValue;
      });
  }

  // Update team performance table
  function updateTeamPerformanceTable() {
      const tableBody = document.getElementById('performanceTableBody');
      if (!tableBody || !stylistsData || stylistsData.length === 0) return;

      // Sort stylists by performance score
      const sortedStylists = [...stylistsData].sort((a, b) => {
          const scoreA = (a.totalPosts * 0.3) + (a.totalViews * 0.4) + (a.engagementRate * 0.3);
          const scoreB = (b.totalPosts * 0.3) + (b.totalViews * 0.4) + (b.engagementRate * 0.3);
          return scoreB - scoreA;
      });

      tableBody.innerHTML = sortedStylists.map((stylist, index) => {
          const performanceScore = Math.round((stylist.totalPosts * 0.3) + (stylist.totalViews * 0.4) + (stylist.engagementRate * 0.3));
          const scoreColor = performanceScore >= 80 ? '#22c55e' :
                           performanceScore >= 60 ? '#667eea' : '#f59e0b';

          return `
              <div class="performance-grid" onclick="openStylistDetail('${stylist.id}')">
                  <div class="stylist-info">
                      <div class="stylist-avatar">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
                      <div>
                          <div style="font-weight: 600;">${stylist.stylist_name}</div>
                          <div style="font-size: 0.8rem; color: #666;">${stylist.email || 'No email'}</div>
                      </div>
                  </div>
                  <div class="performance-metric">
                      <div class="performance-value">${stylist.totalPosts}</div>
                  </div>
                  <div class="performance-metric">
                      <div class="performance-value">${stylist.totalViews.toLocaleString()}</div>
                  </div>
                  <div class="performance-metric">
                      <div class="performance-value">${stylist.totalClients}</div>
                  </div>
                  <div class="performance-metric">
                      <div class="performance-value">${stylist.engagementRate}%</div>
                  </div>
                  <div class="performance-metric">
                      <div class="performance-value" style="color: ${scoreColor};">${performanceScore}</div>
                  </div>
              </div>
          `;
      }).join('');
  }

  // AI BUSINESS ADVISOR FUNCTIONS

  function getSalonBusinessStage(analytics) {
      if (!analytics) return 'startup';

      const totalStylists = analytics.totalStylists || analytics.total_stylists || 0;
      const totalClients = analytics.totalClients || analytics.total_clients || 0;
      const totalPosts = analytics.totalShares || analytics.total_media_sends || 0;

      if (totalStylists <= 2 && totalClients < 50 && totalPosts < 100) return 'startup';
      if (totalStylists <= 5 && totalClients < 200 && totalPosts < 500) return 'growing';
      if (totalStylists <= 10 && totalClients < 500 && totalPosts < 1500) return 'established';
      return 'enterprise';
  }

  async function generateAIInsights(isManual = false) {
      // Prevent rapid API calls
      const now = Date.now();
      if (!isManual && (now - lastAIGeneration) < 30000) {
          console.log('AI generation skipped - too soon');
          return;
      }

      if (isGeneratingAI) {
          console.log('AI generation already in progress');
          return;
      }

      isGeneratingAI = true;
      lastAIGeneration = now;

      // Show loading state
      document.getElementById('aiLoading').style.display = 'flex';
      document.getElementById('aiMessage').style.display = 'none';
      document.getElementById('aiWelcome').style.display = 'none';

      try {
          console.log('Calling AI with salon business insights...');

          // Call AI service with overview action type and analytics data
          const response = await callAIService('', 'overview', currentAnalyticsData);
          displayAIMessage(response);

          const totalStylists = currentAnalyticsData?.total_stylists || 0;
          const totalClients = currentAnalyticsData?.total_clients || 0;
          const totalPosts = currentAnalyticsData?.total_media_sends || 0;
          const stage = getSalonBusinessStage({ totalStylists, totalClients, totalShares: totalPosts });
          updateAIStage(stage);

      } catch (error) {
          console.error('AI generation failed:', error);

          // Fallback message based on salon data
          const fallbackMessage = generateFallbackMessage();
          displayAIMessage(fallbackMessage);

      } finally {
          isGeneratingAI = false;
          document.getElementById('aiLoading').style.display = 'none';
      }
  }

  function generateFallbackMessage() {
      const totalStylists = currentAnalyticsData?.total_stylists || 0;
      const totalClients = currentAnalyticsData?.total_clients || 0;
      const totalPosts = currentAnalyticsData?.total_media_sends || 0;
      const salonName = salonData?.salon_name || 'Your salon';

      if (totalStylists === 0) {
          return `${salonName}, you're just getting started! Focus on adding your first stylist and creating your salon profile. Once you have team members using PostMyStyle.AI, you'll unlock powerful analytics and growth insights. Start by inviting your stylists to join the platform! 🚀`;
      } else if (totalClients < 20) {
          return `${salonName}, great progress with ${totalStylists} stylist${totalStylists > 1 ? 's' : ''} on your team! Focus on building your client base through consistent social media posting and referral programs. Encourage your stylists to share before/after photos to showcase your work. Your ${totalPosts} posts are a great start! 💪`;
      } else {
          return `${salonName}, you're building momentum with ${totalStylists} stylists serving ${totalClients} clients! Your ${totalPosts} AI-generated posts show strong content creation. Focus on converting social engagement into bookings and consider premium service offerings to increase revenue per client. Keep up the excellent work! ⭐`;
      }
  }

  function displayAIMessage(message) {
      // Clean the message first
      const cleanedMessage = cleanAIResponse(message);
      aiMessageFull = cleanedMessage;

      // Truncate message if too long
      if (cleanedMessage.length > 200) {
          aiMessageTruncated = cleanedMessage.substring(0, 200) + '...';
          document.getElementById('aiExpandBtn').style.display = 'flex';
      } else {
          aiMessageTruncated = cleanedMessage;
          document.getElementById('aiExpandBtn').style.display = 'none';
      }

      // Format the message for display
      const formattedMessage = formatAIInsight(isAIExpanded ? aiMessageFull : aiMessageTruncated);
      document.getElementById('aiMessageText').innerHTML = formattedMessage;
      document.getElementById('aiMessage').style.display = 'block';
      document.getElementById('aiWelcome').style.display = 'none';

      // Update last updated time
      const now = new Date();
      document.getElementById('aiLastUpdated').textContent = `Updated: ${now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
  }

  function updateAIStage(stage) {
      const stageLabels = {
          startup: 'Startup Salon',
          growing: 'Growing Business',
          established: 'Established Salon',
          enterprise: 'Enterprise Operation'
      };

      document.getElementById('aiStageText').textContent = `Business Stage: ${stageLabels[stage] || 'Growing Salon'}`;
  }

  function toggleAIMessage() {
      isAIExpanded = !isAIExpanded;
      const formattedMessage = formatAIInsight(isAIExpanded ? aiMessageFull : aiMessageTruncated);
      document.getElementById('aiMessageText').innerHTML = formattedMessage;
      document.getElementById('expandText').textContent = isAIExpanded ? 'Show Less' : 'Read More';
      document.getElementById('expandIcon').textContent = isAIExpanded ? '▲' : '▼';
  }

  function toggleQuickActions() {
      const section = document.getElementById('quickActionsSection');
      const btn = document.getElementById('quickActionsBtn');
      const customSection = document.getElementById('customQuestionSection');
      const customBtn = document.getElementById('customQuestionBtn');

      if (section.style.display === 'none' || section.style.display === '') {
          section.style.display = 'block';
          btn.classList.add('active');
          // Hide custom question section
          customSection.style.display = 'none';
          customBtn.classList.remove('active');
      } else {
          section.style.display = 'none';
          btn.classList.remove('active');
      }
  }

  function toggleCustomQuestion() {
      const section = document.getElementById('customQuestionSection');
      const btn = document.getElementById('customQuestionBtn');
      const quickSection = document.getElementById('quickActionsSection');
      const quickBtn = document.getElementById('quickActionsBtn');

      if (section.style.display === 'none' || section.style.display === '') {
          section.style.display = 'block';
          btn.classList.add('active');
          // Hide quick actions section
          quickSection.style.display = 'none';
          quickBtn.classList.remove('active');
          // Focus on input
          document.getElementById('customQuestionInput').focus();
      } else {
          section.style.display = 'none';
          btn.classList.remove('active');
      }
  }

  async function askQuickQuestion(topic) {
      const quickActionTypes = {
          revenue: 'How can I increase revenue at my salon? Focus on practical strategies I can implement this month.',
          clients: 'What are the best ways to attract new clients to my salon? Give me specific marketing tactics.',
          team: 'How can I improve my team performance and motivation? What management strategies work best?',
          marketing: 'What marketing strategies should I focus on to grow my salon business? Include social media tips.'
      };

      // Hide quick actions
      document.getElementById('quickActionsSection').style.display = 'none';
      document.getElementById('quickActionsBtn').classList.remove('active');

      // Show loading and call AI
      document.getElementById('aiLoading').style.display = 'flex';
      document.getElementById('aiMessage').style.display = 'none';

      try {
          const questionText = quickActionTypes[topic] || topic;
          const response = await callAIService('', questionText, currentAnalyticsData);
          displayAIMessage(response);
      } catch (error) {
          console.error('Quick question failed:', error);
          const fallback = generateQuickFallback(topic);
          displayAIMessage(fallback);
      } finally {
          document.getElementById('aiLoading').style.display = 'none';
      }
  }

  async function askCustomQuestion() {
      const question = document.getElementById('customQuestionInput').value.trim();
      if (!question) {
          alert('Please enter a question first.');
          return;
      }

      // Hide custom section
      document.getElementById('customQuestionSection').style.display = 'none';
      document.getElementById('customQuestionBtn').classList.remove('active');

      // Clear input
      document.getElementById('customQuestionInput').value = '';

      // Show loading and call AI
      document.getElementById('aiLoading').style.display = 'flex';
      document.getElementById('aiMessage').style.display = 'none';

      try {
          // Pass the question directly with analytics context
          const response = await callAIService('', question, currentAnalyticsData);
          displayAIMessage(response);
      } catch (error) {
          console.error('Custom question failed:', error);
          const salonName = salonData?.salon_name || 'Your salon';
          const fallback = `${salonName}, thank you for your question: "${question}". Based on your current metrics, I recommend focusing on consistent growth strategies. Your salon is making great progress! Try the quick action buttons for specific business advice.`;
          displayAIMessage(fallback);
      } finally {
          document.getElementById('aiLoading').style.display = 'none';
      }
  }

  function generateQuickFallback(topic) {
      const salonName = salonData?.salon_name || 'Your salon';
      const fallbacks = {
          revenue: `${salonName}, to increase revenue: 1) Introduce premium services and packages, 2) Implement referral rewards for existing clients, 3) Focus on retail product sales after each service. Your stylists can showcase products in their social posts!`,
          clients: `${salonName}, to attract clients: 1) Encourage stylists to post before/after photos consistently, 2) Create limited-time new client promotions, 3) Partner with local businesses for cross-promotion. Social media consistency is key!`,
          team: `${salonName}, for team performance: 1) Set monthly social posting goals for each stylist, 2) Implement performance bonuses tied to client retention, 3) Provide ongoing training on social media best practices. Support your team's growth!`,
          marketing: `${salonName}, for marketing: 1) Post client transformations daily across all platforms, 2) Create hashtag campaigns specific to your salon, 3) Engage with local community events and influencers. Consistency builds brand recognition!`
      };
      return fallbacks[topic] || fallbacks.revenue;
  }

  // DRILL-DOWN FUNCTIONALITY

  function openDrillDown(type) {
      if (!stylistsData || stylistsData.length === 0) {
          alert('Stylist data is still loading. Please try again in a moment.');
          return;
      }

      const modal = document.getElementById('drillDownModal');
      const title = document.getElementById('modalTitle');
      const content = document.getElementById('modalContent');

      switch(type) {
          case 'stylists':
              title.textContent = 'Stylist Performance';
              content.innerHTML = generateStylistDrillDown();
              break;
          case 'clients':
              title.textContent = 'Client Breakdown by Stylist';
              content.innerHTML = generateClientDrillDown();
              break;
          case 'posts':
              title.textContent = 'Post Activity by Stylist';
              content.innerHTML = generatePostDrillDown();
              break;
          case 'views':
              title.textContent = 'View Performance by Stylist';
              content.innerHTML = generateViewDrillDown();
              break;
          case 'engagement':
              title.textContent = 'Engagement by Stylist';
              content.innerHTML = generateEngagementDrillDown();
              break;
          case 'products':
              title.textContent = 'Product Performance';
              content.innerHTML = generateProductDrillDown();
              break;
      }

      modal.classList.add('active');
  }

  function closeDrillDown() {
      document.getElementById('drillDownModal').classList.remove('active');
  }

  function generateStylistDrillDown() {
      return stylistsData.map(stylist => `
          <div class="stylist-card">
              <div class="stylist-header">
                  <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
                  <div class="stylist-info">
                      <h3>${stylist.stylist_name}</h3>
                      <p>${stylist.email || 'No email provided'}</p>
                  </div>
              </div>
              <div class="stylist-stats">
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts}</div>
                      <div class="stylist-stat-label">Posts</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalViews}</div>
                      <div class="stylist-stat-label">Views</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalClients}</div>
                      <div class="stylist-stat-label">Clients</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.engagementRate}%</div>
                      <div class="stylist-stat-label">Engagement</div>
                  </div>
              </div>
          </div>
      `).join('');
  }

  function generateClientDrillDown() {
      return stylistsData.map(stylist => `
          <div class="stylist-card">
              <div class="stylist-header">
                  <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
                  <div class="stylist-info">
                      <h3>${stylist.stylist_name}</h3>
                      <p>${stylist.totalClients} clients served</p>
                  </div>
              </div>
              <div class="stylist-stats">
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalClients}</div>
                      <div class="stylist-stat-label">Total Clients</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalClients / stylist.totalPosts * 10) / 10 : 0}</div>
                      <div class="stylist-stat-label">Clients per Post</div>
                  </div>
              </div>
          </div>
      `).join('');
  }

  function generatePostDrillDown() {
      return stylistsData.map(stylist => `
          <div class="stylist-card">
              <div class="stylist-header">
                  <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
                  <div class="stylist-info">
                      <h3>${stylist.stylist_name}</h3>
                      <p>${stylist.totalPosts} posts created</p>
                  </div>
              </div>
              <div class="stylist-stats">
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts}</div>
                      <div class="stylist-stat-label">Total Posts</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalViews / stylist.totalPosts) : 0}</div>
                      <div class="stylist-stat-label">Avg Views per Post</div>
                  </div>
              </div>
          </div>
      `).join('');
  }

  function generateViewDrillDown() {
      return stylistsData.map(stylist => `
          <div class="stylist-card">
              <div class="stylist-header">
                  <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
                  <div class="stylist-info">
                      <h3>${stylist.stylist_name}</h3>
                      <p>${stylist.totalViews} total views</p>
                  </div>
              </div>
              <div class="stylist-stats">
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalViews}</div>
                      <div class="stylist-stat-label">Total Views</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalViews / stylist.totalPosts) : 0}</div>
                      <div class="stylist-stat-label">Views per Post</div>
                  </div>
              </div>
          </div>
      `).join('');
  }

  function generateEngagementDrillDown() {
      return stylistsData.map(stylist => `
          <div class="stylist-card">
              <div class="stylist-header">
                  <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
                  <div class="stylist-info">
                      <h3>${stylist.stylist_name}</h3>
                      <p>${stylist.engagementRate}% engagement rate</p>
                  </div>
              </div>
              <div class="stylist-stats">
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.engagementRate}%</div>
                      <div class="stylist-stat-label">Engagement Rate</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts}</div>
                      <div class="stylist-stat-label">Posts Created</div>
                  </div>
              </div>
          </div>
      `).join('');
  }

  function generateProductDrillDown() {
      return `
          <div class="stylist-card">
              <div class="stylist-header">
                  <div class="stylist-avatar-large">📦</div>
                  <div class="stylist-info">
                      <h3>Product Analytics</h3>
                      <p>Coming soon - detailed product performance by stylist</p>
                  </div>
              </div>
              <div class="stylist-stats">
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${document.getElementById('productClicks').textContent}</div>
                      <div class="stylist-stat-label">Total Clicks</div>
                  </div>
              </div>
          </div>
      `;
  }

  // Interactive Functions
  function refreshDashboard() {
      console.log('Refreshing dashboard...');
      showRefreshIndicator();

      if (salonData) {
          // Only refresh data, don't reinitialize charts
          loadSalonAnalytics(salonData.salon_id);
          loadStylistsData(salonData.salon_id);
          updateLastRefreshedTime();
      }
  }

  // Show error state
  function showErrorState(message) {
      const metricsGrid = document.querySelector('.metrics-grid');
      metricsGrid.innerHTML = `
          <div class="error-message" style="grid-column: 1 / -1;">
              <strong>⚠️ ${message}</strong><br>
              <small>Try refreshing the page or contact support if the issue persists.</small>
          </div>
      `;
  }

  // Logout function
  async function logout() {
      console.log('Logging out...');

      // Clear auto-refresh interval
      if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
      }

      try {
          // Sign out from Supabase
          const { error } = await supabase.auth.signOut();

          if (error) {
              console.error('Logout error:', error);
          }
      } catch (error) {
          console.error('Logout error:', error);
      }

      // Clear stored authentication data
      localStorage.removeItem('authToken');
      localStorage.removeItem('userInfo');
      localStorage.removeItem('salonInfo');

      // Clear session storage
      sessionStorage.clear();

      console.log('Logout complete, redirecting...');

      // Redirect to home page
      window.location.href = 'index.html';
  }

  // Event Listeners

  // Close modal when clicking outside
  document.getElementById('drillDownModal').addEventListener('click', function(e) {
      if (e.target === this) {
          closeDrillDown();
      }
  });

  // Close modal with Escape key
  document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
          closeDrillDown();
      }
  });

  // Allow Enter key to send custom question
  document.getElementById('customQuestionInput').addEventListener('keypress', function(e) {
      if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          askCustomQuestion();
      }
  });

  // Add interactivity for chart controls
  document.querySelectorAll('.chart-control').forEach(btn => {
      btn.addEventListener('click', function() {
          // Remove active class from siblings
          this.parentNode.querySelectorAll('.chart-control').forEach(sibling => {
              sibling.classList.remove('active');
          });
          // Add active class to clicked button
          this.classList.add('active');

          // Update chart based on selection
          const chartType = this.textContent;
          console.log('Switching to:', chartType);

          // Update chart data based on selection
          if (activityChart) {
              switch(chartType) {
                  case 'Views':
                      updateChartToViews();
                      break;
                  case 'Engagement':
                      updateChartToEngagement();
                      break;
                  default:
                      updateChartToPosts();
              }
          }
      });
  });

  // Add interactivity for time range selector
  document.querySelectorAll('.time-btn').forEach(btn => {
      btn.addEventListener('click', function() {
          // Remove active class from siblings
          this.parentNode.querySelectorAll('.time-btn').forEach(sibling => {
              sibling.classList.remove('active');
          });
          // Add active class to clicked button
          this.classList.add('active');

          // Update data based on time range
          const timeRange = this.textContent;
          console.log('Time range changed to:', timeRange);

          // Refresh data with new time range
          if (salonData) {
              loadSalonAnalytics(salonData.salon_id);
              loadStylistsData(salonData.salon_id);
          }
      });
  });

  // Chart update functions for different views
  function updateChartToPosts() {
      console.log('Switching chart to Posts view');
      if (!activityChart || !stylistsData?.length) {
          console.log('Chart or data not ready for Posts view');
          return;
      }

      const topStylists = stylistsData
          .sort((a, b) => b.totalPosts - a.totalPosts)
          .slice(0, 4);

      topStylists.forEach((stylist, index) => {
          if (activityChart.data.datasets[index]) {
              const weeklyData = generateRealisticWeeklyData(stylist);
              activityChart.data.datasets[index].data = weeklyData;
          }
      });
      activityChart.update('active');
  }

  function updateChartToViews() {
      console.log('Switching chart to Views view');
      if (!activityChart || !stylistsData?.length) {
          console.log('Chart or data not ready for Views view');
          return;
      }

      const topStylists = stylistsData
          .sort((a, b) => b.totalViews - a.totalViews)
          .slice(0, 4);

      topStylists.forEach((stylist, index) => {
          if (activityChart.data.datasets[index]) {
              // Create weekly data based on views (scaled down for chart readability)
              const weeklyPattern = [0.6, 1.2, 1.0, 1.1, 1.3, 1.4, 0.4];
              const avgDailyViews = stylist.totalViews / 30 / 10; // Scale down for readability
              const weeklyData = weeklyPattern.map(multiplier =>
                  Math.max(0, Math.round(avgDailyViews * multiplier * 7))
              );
              activityChart.data.datasets[index].data = weeklyData;
          }
      });
      activityChart.update('active');
  }

  function updateChartToEngagement() {
      console.log('Switching chart to Engagement view');
      if (!activityChart || !stylistsData?.length) {
          console.log('Chart or data not ready for Engagement view');
          return;
      }

      const topStylists = stylistsData
          .sort((a, b) => b.engagementRate - a.engagementRate)
          .slice(0, 4);

      topStylists.forEach((stylist, index) => {
          if (activityChart.data.datasets[index]) {
              // Create weekly data based on engagement rate
              const weeklyPattern = [0.6, 1.2, 1.0, 1.1, 1.3, 1.4, 0.4];
              const baseEngagement = stylist.engagementRate / 10; // Scale for chart
              const weeklyData = weeklyPattern.map(multiplier =>
                  Math.max(0, Math.round(baseEngagement * multiplier))
              );
              activityChart.data.datasets[index].data = weeklyData;
          }
      });
      activityChart.update('active');
  }

  // Page visibility API for auto-refresh management
  document.addEventListener('visibilitychange', function() {
      if (document.hidden) {
          // Page is hidden, pause auto-refresh
          if (autoRefreshInterval) {
              clearInterval(autoRefreshInterval);
              console.log('Auto-refresh paused - page hidden');
          }
      } else {
          // Page is visible, resume auto-refresh (but don't reinitialize charts)
          startAutoRefresh();
          console.log('Auto-refresh resumed - page visible');
      }
  });

  // Cleanup on page unload
  window.addEventListener('beforeunload', function() {
      if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
      }
  });

  // Enhanced performance table functionality
  function openStylistDetail(stylistId) {
      const stylist = stylistsData.find(s => s.id === stylistId);
      if (!stylist) return;

      const modal = document.getElementById('drillDownModal');
      const title = document.getElementById('modalTitle');
      const content = document.getElementById('modalContent');

      title.textContent = `${stylist.stylist_name} - Detailed Performance`;
      content.innerHTML = `
          <div class="stylist-card">
              <div class="stylist-header">
                  <div class="stylist-avatar-large">${stylist.stylist_name.charAt(0).toUpperCase()}</div>
                  <div class="stylist-info">
                      <h3>${stylist.stylist_name}</h3>
                      <p>${stylist.email || 'No email provided'}</p>
                      <p style="color: #667eea; font-weight: 600;">Performance Score: ${Math.round((stylist.totalPosts * 0.3) + (stylist.totalViews * 0.4) + (stylist.engagementRate * 0.3))}/100</p>
                  </div>
              </div>
              <div class="stylist-stats">
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts}</div>
                      <div class="stylist-stat-label">Total Posts</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalViews}</div>
                      <div class="stylist-stat-label">Total Views</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalClients}</div>
                      <div class="stylist-stat-label">Total Clients</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.engagementRate}%</div>
                      <div class="stylist-stat-label">Engagement Rate</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalViews / stylist.totalPosts) : 0}</div>
                      <div class="stylist-stat-label">Avg Views/Post</div>
                  </div>
                  <div class="stylist-stat">
                      <div class="stylist-stat-number">${stylist.totalPosts > 0 ? Math.round(stylist.totalClients / stylist.totalPosts * 10) / 10 : 0}</div>
                      <div class="stylist-stat-label">Clients/Post Ratio</div>
                  </div>
              </div>
          </div>

          <div style="margin-top: 2rem;">
              <h4 style="color: #333; margin-bottom: 1rem;">💡 Performance Insights</h4>
              <div class="insight-item ${stylist.totalPosts >= 20 ? 'insight-positive' : 'insight-warning'}">
                  <div class="insight-title">📱 Content Creation</div>
                  <div class="insight-desc">${stylist.totalPosts >= 20 ?
                      `Excellent content creation with ${stylist.totalPosts} posts! Keep up the consistent posting.` :
                      `Room for improvement - aim for 20+ posts. Currently at ${stylist.totalPosts} posts.`}</div>
              </div>
              <div class="insight-item ${stylist.engagementRate >= 50 ? 'insight-positive' : 'insight-warning'}">
                  <div class="insight-title">❤️ Engagement Performance</div>
                  <div class="insight-desc">${stylist.engagementRate >= 50 ?
                      `Strong engagement at ${stylist.engagementRate}%! Your content resonates well with audiences.` :
                      `Focus on engagement - currently at ${stylist.engagementRate}%. Try more interactive content.`}</div>
              </div>
              <div class="insight-item ${stylist.totalClients >= 15 ? 'insight-positive' : ''}">
                  <div class="insight-title">👥 Client Base</div>
                  <div class="insight-desc">${stylist.totalClients >= 15 ?
                      `Great client base with ${stylist.totalClients} clients! Focus on retention and referrals.` :
                      `Building client base - currently ${stylist.totalClients} clients. Increase social media visibility.`}</div>
              </div>
          </div>
      `;

      modal.classList.add('active');
  }

  // Sidebar navigation functions
  function showDashboard() {
      setActiveNavItem('Dashboard');
      // Dashboard is already visible - could scroll to top or refresh
      window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function showTeamPerformance() {
      setActiveNavItem('Team Performance');
      // Scroll to team performance table
      document.querySelector('.performance-table').scrollIntoView({ behavior: 'smooth' });
  }

  function showSocialAnalytics() {
      setActiveNavItem('Social Analytics');
      // Scroll to metrics grid (social analytics cards)
      document.querySelector('.metrics-grid').scrollIntoView({ behavior: 'smooth' });
  }

  function showRevenueTracking() {
      setActiveNavItem('Revenue Tracking');
      alert('Revenue Tracking feature coming soon! This will show detailed financial analytics and revenue trends.');
  }

  function showGoalsTargets() {
      setActiveNavItem('Goals & Targets');
      alert('Goals & Targets feature coming soon! This will help you set and track performance goals for your team.');
  }

  function showSettings() {
      setActiveNavItem('Settings');
      alert('Settings feature coming soon! This will allow you to configure salon preferences and user settings.');
  }

  function setActiveNavItem(itemName) {
      // Remove active class from all nav links
      document.querySelectorAll('.nav-link').forEach(link => {
          link.classList.remove('active');
      });

      // Add active class to clicked item
      document.querySelectorAll('.nav-link').forEach(link => {
          if (link.textContent.trim().includes(itemName)) {
              link.classList.add('active');
          }
      });
  }

  // AI Performance Insights Generator
  async function generatePerformanceInsights() {
      const insightsContent = document.getElementById('performanceInsightsContent');

      // Show loading state
      insightsContent.innerHTML = `
          <div style="text-align: center; padding: 2rem;">
              <div class="ai-spinner" style="margin: 0 auto 1rem;"></div>
              <p style="color: #666;">Analyzing team performance data...</p>
          </div>
      `;

      try {
          if (!stylistsData || stylistsData.length === 0) {
              insightsContent.innerHTML = `
                  <div class="insight-item">
                      <div class="insight-title">📊 Getting Started</div>
                      <div class="insight-desc">Add stylists to your team to unlock AI-powered performance insights and recommendations.</div>
                  </div>
              `;
              return;
          }

          // Analyze real data
          const insights = analyzeTeamPerformance();

          // Try to get AI insights if available
          let aiInsight = null;
          try {
              const prompt = `Analyze salon team performance data and provide one key business insight: ${insights.summary}. Focus on actionable recommendations.`;
              const rawInsight = await callAIService('', prompt, currentAnalyticsData);

              // Clean up the AI response - remove any meta-text
              aiInsight = cleanAIResponse(rawInsight);
          } catch (error) {
              console.log('AI insight generation failed, using data analysis');
          }

          // Display insights
          let insightsHTML = '';

          if (aiInsight) {
              insightsHTML += `
                  <div class="insight-item" style="background: linear-gradient(135deg, #f0f9ff, #e0f2fe); border-left-color: #0ea5e9;">
                      <div class="insight-title">🧠 AI Business Analysis</div>
                      <div class="insight-desc" style="line-height: 1.6;">${formatAIInsight(aiInsight)}</div>
                  </div>
              `;
          }

          // Add data-driven insights
          insights.items.forEach(insight => {
              insightsHTML += `
                  <div class="insight-item ${insight.type}">
                      <div class="insight-title">${insight.title}</div>
                      <div class="insight-desc">${insight.description}</div>
                  </div>
              `;
          });

          insightsContent.innerHTML = insightsHTML;

      } catch (error) {
          console.error('Error generating performance insights:', error);
          insightsContent.innerHTML = `
              <div class="insight-item insight-warning">
                  <div class="insight-title">⚠️ Analysis Error</div>
                  <div class="insight-desc">Unable to generate insights at this time. Please try again later.</div>
              </div>
          `;
      }
  }

  // Analyze team performance based on real data
  function analyzeTeamPerformance() {
      if (!stylistsData || stylistsData.length === 0) {
          return { items: [], summary: 'No team data available' };
      }

      const insights = [];
      let summary = '';

      // Analyze top performer
      const topPerformer = stylistsData.reduce((prev, current) =>
          (prev.totalPosts > current.totalPosts) ? prev : current
      );

      if (topPerformer.totalPosts > 0) {
          insights.push({
              type: 'insight-positive',
              title: `⭐ Top Performer: ${topPerformer.stylist_name}`,
              description: `Leading with ${topPerformer.totalPosts} posts and ${topPerformer.engagementRate}% engagement. Consider having them mentor other team members.`
          });
      }

      // Analyze engagement rates
      const avgEngagement = stylistsData.reduce((sum, s) => sum + s.engagementRate, 0) / stylistsData.length;
      const lowEngagement = stylistsData.filter(s => s.engagementRate < avgEngagement * 0.7);

      if (lowEngagement.length > 0) {
          insights.push({
              type: 'insight-warning',
              title: '📈 Engagement Opportunity',
              description: `${lowEngagement.length} team member(s) have below-average engagement. Focus on content quality and posting consistency.`
          });
      }

      // Analyze posting consistency
      const totalPosts = stylistsData.reduce((sum, s) => sum + s.totalPosts, 0);
      const avgPosts = totalPosts / stylistsData.length;

      if (avgPosts < 10) {
          insights.push({
              type: 'insight-warning',
              title: '📱 Content Creation Goal',
              description: `Team average is ${Math.round(avgPosts)} posts. Aim for 20+ posts per stylist for better visibility and client engagement.`
          });
      } else {
          insights.push({
              type: 'insight-positive',
              title: '🎯 Strong Content Creation',
              description: `Great job! Team average of ${Math.round(avgPosts)} posts shows consistent content creation.`
          });
      }

      // Client to post ratio analysis
      const totalClients = stylistsData.reduce((sum, s) => sum + s.totalClients, 0);
      const clientPostRatio = totalClients / Math.max(totalPosts, 1);

      if (clientPostRatio > 1) {
          insights.push({
              type: 'insight-positive',
              title: '💝 Client Engagement Success',
              description: `Excellent client-to-post ratio of ${clientPostRatio.toFixed(1)}. Your content is effectively reaching and engaging clients.`
          });
      }

      summary = `${stylistsData.length} stylists, ${totalPosts} total posts, ${Math.round(avgEngagement)}% avg engagement, ${totalClients} total clients`;

      return { items: insights, summary };
  }

  // Clean AI response from meta-text and formatting instructions
  function cleanAIResponse(response) {
      if (!response) return '';

      // Remove common meta-text patterns
      let cleaned = response
          .replace(/\*\*Key Insight \([^)]+\):\*\*/g, '')
          .replace(/\*\*Specific Advice \([^)]+\):\*\*/g, '')
          .replace(/\(?\d+\s*words?\)?/gi, '')
          .replace(/Under \d+ words/gi, '')
          .replace(/In \d+ words/gi, '')
          .replace(/Key Insight:/gi, '')
          .replace(/Specific Advice:/gi, '')
          .replace(/^\*\*|\*\*$/g, '')
          .trim();

      return cleaned;
  }

  // Format AI insight for better UX
  function formatAIInsight(insight) {
      if (!insight) return '';

      // Split into paragraphs and format numbered lists
      let formatted = insight
          .split('\n')
          .map(line => line.trim())
          .filter(line => line.length > 0)
          .map(line => {
              // Format numbered points
              if (/^\d+\./.test(line)) {
                  return `<strong style="color: #0ea5e9;">• ${line.replace(/^\d+\.\s*/, '')}</strong>`;
              }
              // Format bold sections
              line = line.replace(/\*\*(.*?)\*\*/g, '<strong style="color: #1f2937;">$1</strong>');
              return line;
          })
          .join('<br><br>');

      return formatted;
  }

  // Enhanced error handling
  window.addEventListener('error', function(e) {
      console.error('JavaScript error:', e.error);
      // Don't show error to user unless it's critical
  });

  // Network status monitoring
  window.addEventListener('online', function() {
      console.log('Network connection restored');
      if (salonData) {
          refreshDashboard();
      }
  });

  window.addEventListener('offline', function() {
      console.log('Network connection lost');
      // Pause auto-refresh when offline
      if (autoRefreshInterval) {
          clearInterval(autoRefreshInterval);
      }
  });

  // Initialize dashboard when page loads - single initialization
  if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
          console.log('PostMyStyle.ai Dashboard initializing...');
          loadDashboard();
      });
  } else {
      // DOM already loaded
      console.log('PostMyStyle.ai Dashboard initializing (DOM ready)...');
      loadDashboard();
  }

</script>
</body>
</html>