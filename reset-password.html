import React, { useState, useCallback } from 'react';
import {
View,
Text,
TextInput,
TouchableOpacity,
StyleSheet,
KeyboardAvoidingView,
Platform,
Image,
Dimensions,
ScrollView,
StatusBar,
Alert,
ActivityIndicator,
SafeAreaView,
} from 'react-native';
import { supabase } from '../services/supabase';
import Logo from '../assets/images/postmystyle-logo.png';

const { width: SCREEN_WIDTH } = Dimensions.get('window');

export default function ForgotPasswordScreen({ navigation }) {
const [email, setEmail] = useState('');
const [loading, setLoading] = useState(false);
const [emailSent, setEmailSent] = useState(false);
const [validationError, setValidationError] = useState('');

const validateEmail = (email) => {
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
return emailRegex.test(email);
};

const updateEmail = useCallback((value) => {
setEmail(value);
if (validationError) {
setValidationError('');
}
}, [validationError]);

const validateInput = () => {
const trimmedEmail = email.trim();

if (!trimmedEmail) {
setValidationError('Email is required');
return false;
} else if (!validateEmail(trimmedEmail)) {
setValidationError('Please enter a valid email address');
return false;
}

setValidationError('');
return true;
};

const isNetworkError = (error) => {
if (!error) return false;

const errorMessage = error.message?.toLowerCase() || '';
const errorName = error.name?.toLowerCase() || '';

const networkKeywords = [
'network',
'connection',
'timeout',
'fetch',
'offline',
'no internet',
'unreachable',
'dns',
'socket',
'abort',
'enotfound',
'econnrefused',
'econnreset',
'enetunreach'
];

return networkKeywords.some(keyword =>
errorMessage.includes(keyword) || errorName.includes(keyword)
) || error.code === 'NETWORK_ERROR' || error.name === 'NetworkError';
};

const getErrorMessage = (error) => {
switch (error?.message) {
case 'User not found':
return 'No account found with this email address. Please check your email or contact your admin.';
case 'Too many requests':
return 'Too many reset attempts. Please wait a moment and try again.';
default:
return error?.message || 'Unable to send reset email. Please try again.';
}
};

const handleResetPassword = async () => {
if (!validateInput()) {
Alert.alert('Invalid Input', validationError);
return;
}

setLoading(true);

try {
// Fixed for web reset page
const { error } = await supabase.auth.api.resetPasswordForEmail(email.trim(), {
redirectTo: 'https://postmystyle.ai/reset-password',
});

if (error) {
Alert.alert('Reset Failed', getErrorMessage(error));
} else {
setEmailSent(true);
}
} catch (err) {
console.error('Reset password error:', err);

if (isNetworkError(err)) {
Alert.alert('Network Error', 'Network error. Please check your internet connection and try again.');
} else {
Alert.alert('Error', 'An unexpected error occurred. Please try again.');
}
} finally {
setLoading(false);
}
};

const handleBackToLogin = () => {
navigation.goBack();
};

const handleResendEmail = () => {
setEmailSent(false);
// Keep the email filled so user can try again or modify
};

if (emailSent) {
return (
<SafeAreaView style={styles.safeArea}>
  <StatusBar barStyle="dark-content" backgroundColor="#ffffff" />
  <ScrollView
          contentContainerStyle={styles.scrollContainer}
          showsVerticalScrollIndicator={false}
  >
    <View style={styles.inner}>
      <Image source={Logo} style={styles.logo} />

      <View style={styles.successContainer}>
        <Text style={styles.successIcon}>üìß</Text>
        <Text style={styles.successTitle}>Check Your Email</Text>
        <Text style={styles.successMessage}>
          We've sent password reset instructions to:
        </Text>
        <Text style={styles.emailDisplay}>{email}</Text>
        <Text style={styles.successInstructions}>
          Click the link in the email to reset your password. If you don't see it, check your spam folder.
        </Text>
      </View>

      <TouchableOpacity
              style={styles.button}
              onPress={handleBackToLogin}
      >
        <Text style={styles.buttonText}>Back to Login</Text>
      </TouchableOpacity>

      <TouchableOpacity
              style={styles.secondaryButton}
              onPress={handleResendEmail}
      >
        <Text style={styles.secondaryButtonText}>Try Different Email</Text>
      </TouchableOpacity>
    </View>
  </ScrollView>
</SafeAreaView>
);
}

return (
<SafeAreaView style={styles.safeArea}>
  <StatusBar barStyle="dark-content" backgroundColor="#ffffff" />
  <KeyboardAvoidingView
          style={styles.container}
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
  keyboardVerticalOffset={Platform.OS === 'ios' ? 0 : 20}
  >
  <ScrollView
          contentContainerStyle={styles.scrollContainer}
          keyboardShouldPersistTaps="handled"
          showsVerticalScrollIndicator={false}
  >
    <View style={styles.inner}>
      <TouchableOpacity
              style={styles.backButton}
              onPress={handleBackToLogin}
      >
        <Text style={styles.backButtonText}>‚Üê Back</Text>
      </TouchableOpacity>

      <Image source={Logo} style={styles.logo} />

      <Text style={styles.title}>Reset Password</Text>

      <View style={styles.instructionContainer}>
        <Text style={styles.instructionText}>
          Enter your email address and we'll send you instructions to reset your password.
        </Text>
      </View>

      <View style={styles.inputContainer}>
        <TextInput
                style={[
                styles.input,
                validationError && styles.inputError
                ]}
                placeholder="Email"
                placeholderTextColor="#666"
                autoCapitalize="none"
                keyboardType="email-address"
                value={email}
                onChangeText={updateEmail}
                editable={!loading}
                accessibilityLabel="Email address"
                accessibilityHint="Enter your email address to receive reset instructions"
                autoComplete="email"
                textContentType="emailAddress"
                autoFocus={true}
        />
        {validationError && (
        <Text style={styles.errorText}>{validationError}</Text>
        )}
      </View>

      <TouchableOpacity
              style={[styles.button, loading && styles.buttonDisabled]}
              onPress={handleResetPassword}
              disabled={loading}
              accessibilityLabel="Send reset email"
              accessibilityHint="Sends password reset instructions to your email"
              accessibilityRole="button"
      >
        {loading ? (
        <ActivityIndicator color="white" size="small" />
        ) : (
        <Text style={styles.buttonText}>Send Reset Email</Text>
        )}
      </TouchableOpacity>

      <View style={styles.helpContainer}>
        <Text style={styles.helpText}>
          Need help? Contact your admin for assistance.
        </Text>
      </View>
    </View>
  </ScrollView>
  </KeyboardAvoidingView>
</SafeAreaView>
);
}

const styles = StyleSheet.create({
safeArea: {
flex: 1,
backgroundColor: '#ffffff',
},
container: {
flex: 1,
backgroundColor: '#ffffff',
},
scrollContainer: {
flexGrow: 1,
justifyContent: 'center',
},
inner: {
padding: 20,
alignItems: 'center',
width: '100%',
},
backButton: {
alignSelf: 'flex-start',
marginBottom: 20,
padding: 5,
},
backButtonText: {
color: '#007BFF',
fontSize: 16,
fontWeight: '500',
},
logo: {
width: Math.min(SCREEN_WIDTH * 0.5, 200),
height: Math.min(SCREEN_WIDTH * 0.5, 200),
marginVertical: 20,
resizeMode: 'contain',
},
title: {
fontSize: 28,
fontWeight: 'bold',
textAlign: 'center',
marginBottom: 20,
color: '#000',
},
instructionContainer: {
backgroundColor: '#f0f8ff',
borderRadius: 8,
padding: 16,
marginBottom: 30,
width: '100%',
},
instructionText: {
fontSize: 16,
color: '#666',
textAlign: 'center',
lineHeight: 22,
},
inputContainer: {
width: '100%',
marginBottom: 30,
},
input: {
width: '100%',
borderBottomWidth: 1,
borderColor: '#ccc',
padding: 12,
fontSize: 16,
color: '#000',
backgroundColor: 'rgba(245, 245, 245, 0.5)',
},
inputError: {
borderColor: '#ff4444',
borderBottomWidth: 2,
},
errorText: {
color: '#ff4444',
fontSize: 12,
marginTop: 5,
marginLeft: 4,
},
button: {
backgroundColor: '#111',
padding: 15,
borderRadius: 30,
width: '100%',
alignItems: 'center',
marginTop: 10,
height: 55,
justifyContent: 'center',
},
buttonDisabled: {
backgroundColor: '#666',
},
buttonText: {
color: 'white',
fontSize: 18,
fontWeight: '600',
},
secondaryButton: {
backgroundColor: 'transparent',
padding: 15,
borderRadius: 30,
borderWidth: 1,
borderColor: '#007BFF',
width: '100%',
alignItems: 'center',
marginTop: 15,
height: 55,
justifyContent: 'center',
},
secondaryButtonText: {
color: '#007BFF',
fontSize: 16,
fontWeight: '600',
},
helpContainer: {
marginTop: 30,
paddingHorizontal: 20,
},
helpText: {
fontSize: 14,
color: '#666',
textAlign: 'center',
lineHeight: 20,
},
// Success state styles
successContainer: {
alignItems: 'center',
paddingVertical: 20,
width: '100%',
},
successIcon: {
fontSize: 50,
marginBottom: 20,
},
successTitle: {
fontSize: 24,
fontWeight: 'bold',
color: '#000',
marginBottom: 16,
textAlign: 'center',
},
successMessage: {
fontSize: 16,
color: '#666',
textAlign: 'center',
marginBottom: 8,
},
emailDisplay: {
fontSize: 16,
fontWeight: '600',
color: '#007BFF',
marginBottom: 20,
textAlign: 'center',
},
successInstructions: {
fontSize: 14,
color: '#666',
textAlign: 'center',
lineHeight: 20,
marginBottom: 30,
paddingHorizontal: 10,
},
});